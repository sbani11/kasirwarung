<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Transaksi Kasir</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
   
  <header>
    <h1>üõí Transaksi</h1>
    <button onclick="window.location.href='index.html'" class="btn btn-secondary">üè† Home</button>
  </header>
    <body>

    <!-- Search / Scan Barcode -->
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Scan barcode / ketik ID atau Nama Barang..." autofocus>
    </div>

    <!-- Tabel Keranjang -->
    <table>
      <thead>
        <tr>
          <th>Nama Barang</th>
          <th>Qty</th>
          <th>Harga Satuan</th>
          <th>Subtotal</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="keranjang"></tbody>
    </table>

    <!-- Total & Bayar -->
    <div class="total-box">
      <h3>Total: Rp <span id="totalBelanja">0</span></h3>
      <button class="btn btn-primary" id="btnBayar">üí≥ Bayar</button>
    </div>
  </div>

  <script type="module">
    import { db } from './firebase-config.js';
    import { collection, getDocs, addDoc, Timestamp, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    let keranjang = [];
    const keranjangEl = document.getElementById("keranjang");
    const totalEl = document.getElementById("totalBelanja");
    const searchInput = document.getElementById("searchInput");

    // Cari barang by ID atau nama
    async function cariBarang(keyword) {
      const querySnapshot = await getDocs(collection(db, 'barang'));
      keyword = keyword.toLowerCase();
      let found = null;

      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        if (docSnap.id.toLowerCase() === keyword || data.nama.toLowerCase() === keyword) {
          found = { id: docSnap.id, nama: data.nama, harga: data.harga };
        }
      });

      return found;
    }

    // Event scan barcode / tekan enter
    searchInput.addEventListener('keypress', async (e) => {
      if (e.key === 'Enter') {
        const keyword = searchInput.value.trim();
        if (!keyword) return;

        const barang = await cariBarang(keyword);
        if (barang) {
          tambahKeranjang(barang);
        } else {
          alert('Barang tidak ditemukan!');
        }
        searchInput.value = '';
      }
    });

    function tambahKeranjang(barang) {
      const index = keranjang.findIndex(item => item.id === barang.id);
      if (index >= 0) {
        keranjang[index].qty++;
      } else {
        keranjang.push({ ...barang, qty: 1 });
      }
      renderKeranjang();
    }

    function renderKeranjang() {
      keranjangEl.innerHTML = "";
      let total = 0;
      keranjang.forEach((item, i) => {
        const subtotal = item.qty * item.harga;
        total += subtotal;
        keranjangEl.innerHTML += `
          <tr>
            <td>${item.nama}</td>
            <td>
              <button onclick="ubahQty(${i}, -1)">-</button>
              ${item.qty}
              <button onclick="ubahQty(${i}, 1)">+</button>
            </td>
            <td>Rp ${item.harga.toLocaleString("id-ID")}</td>
            <td>Rp ${subtotal.toLocaleString("id-ID")}</td>
            <td><button onclick="hapusItem(${i})">Hapus</button></td>
          </tr>
        `;
      });
      totalEl.textContent = total.toLocaleString("id-ID");
    }

    window.ubahQty = function(i, val) {
      keranjang[i].qty += val;
      if (keranjang[i].qty <= 0) keranjang.splice(i, 1);
      renderKeranjang();
    }

    window.hapusItem = function(i) {
      keranjang.splice(i, 1);
      renderKeranjang();
    }

    document.getElementById("btnBayar").addEventListener("click", async () => {
      if (keranjang.length === 0) {
        alert("Keranjang kosong!");
        return;
      }
      try {
        await addDoc(collection(db, "transaksi"), {
          items: keranjang,
          total: keranjang.reduce((sum, i) => sum + i.harga * i.qty, 0),
          waktu: Timestamp.now(),
          tanggal: serverTimestamp()
        });
        alert("Transaksi berhasil!");
        keranjang = [];
        renderKeranjang();
      } catch (error) {
        console.error("Gagal menyimpan transaksi:", error);
        alert("Terjadi kesalahan saat menyimpan transaksi.");
      }
    });

  </script>
</body>
</html>
